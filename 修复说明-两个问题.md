# âœ… å·²ä¿®å¤ï¼šä¸¤ä¸ªé—®é¢˜

## ğŸ› é—®é¢˜ 1ï¼šæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ä¸æ˜¯å…¨å±€ç”Ÿæ•ˆ

### é—®é¢˜æè¿°
æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤å™¨åœ¨æ·»åŠ ç›´æ’­é—´æ—¶è®¾ç½®ï¼Œå¯¼è‡´åªå¯¹æ–°æ·»åŠ çš„ç›´æ’­é—´ç”Ÿæ•ˆï¼Œè€Œä¸æ˜¯å¯¹æ‰€æœ‰ç›´æ’­é—´ç”Ÿæ•ˆã€‚

### é—®é¢˜åŸå› 
å‰ç«¯ä»£ç åœ¨ `addRoom()` å‡½æ•°ä¸­è®¾ç½®è¿‡æ»¤å™¨ï¼š
```javascript
// é”™è¯¯çš„é€»è¾‘
async function addRoom() {
    // è®¾ç½®è¿‡æ»¤å™¨
    if (filterPattern) {
        await fetch('/api/filter', ...);  // æ¯æ¬¡æ·»åŠ æ—¶è®¾ç½®
    }
    // æ·»åŠ ç›´æ’­é—´
    await fetch('/api/add_room', ...);
}
```

### ä¿®å¤æ–¹æ¡ˆ
å°†è¿‡æ»¤å™¨è®¾ç½®ç‹¬ç«‹ä¸ºå•ç‹¬çš„åŠŸèƒ½ï¼š

**1. å‰ç«¯ç•Œé¢å¢åŠ "è®¾ç½®è¿‡æ»¤"æŒ‰é’®**
```html
<button class="btn btn-primary" onclick="setFilter()">è®¾ç½®è¿‡æ»¤</button>
```

**2. ç‹¬ç«‹çš„è¿‡æ»¤å™¨è®¾ç½®å‡½æ•°**
```javascript
// è®¾ç½®è¿‡æ»¤å™¨ï¼ˆç‹¬ç«‹åŠŸèƒ½ï¼‰
async function setFilter() {
    const filterPattern = document.getElementById('filterPattern').value.trim();

    const response = await fetch('/api/filter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pattern: filterPattern})
    });

    if (result.success) {
        alert(`è¿‡æ»¤å™¨å·²è®¾ç½®: ${filterPattern}\nå°†å¯¹æ‰€æœ‰ç›´æ’­é—´ç”Ÿæ•ˆ`);
    }
}
```

**3. æ·»åŠ ç›´æ’­é—´ä¸å†è®¾ç½®è¿‡æ»¤å™¨**
```javascript
async function addRoom() {
    // åªæ·»åŠ ç›´æ’­é—´ï¼Œä¸è®¾ç½®è¿‡æ»¤å™¨
    const response = await fetch('/api/add_room', ...);
}
```

### ä½¿ç”¨æ–¹æ³•
1. åœ¨"æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤"è¾“å…¥æ¡†è¾“å…¥è¿‡æ»¤è§„åˆ™
2. ç‚¹å‡»"è®¾ç½®è¿‡æ»¤"æŒ‰é’®
3. è¿‡æ»¤å™¨ä¼šå¯¹**æ‰€æœ‰ç›´æ’­é—´**ç”Ÿæ•ˆï¼ˆåŒ…æ‹¬å·²æ·»åŠ å’Œæ–°æ·»åŠ çš„ï¼‰

---

## ğŸ› é—®é¢˜ 2ï¼šåœæ­¢å…¨éƒ¨æŠ¥é”™

### é—®é¢˜æè¿°
ç‚¹å‡»"åœæ­¢å…¨éƒ¨"æŒ‰é’®åæŠ¥é”™ï¼š
```
éƒ¨åˆ†å¯åŠ¨å¤±è´¥ï¼š
'Response' object is not subscriptable
'Response' object is not subscriptable
```

### é—®é¢˜åŸå› 
åœ¨ `start_all()` å‡½æ•°ä¸­ï¼Œè°ƒç”¨ `start_room(room_id)` è¿”å›çš„æ˜¯ Flask Response å¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥ç”¨ä¸‹æ ‡è®¿é—®ï¼š

```python
# é”™è¯¯çš„ä»£ç 
result = start_room(room_id)
if result[1] == 200:  # âŒ Response å¯¹è±¡ä¸æ”¯æŒä¸‹æ ‡è®¿é—®
    started.append(room_id)
else:
    errors.append({'room_id': room_id, 'error': result[0].json['error']})
```

### ä¿®å¤æ–¹æ¡ˆ
ç›´æ¥åœ¨ `start_all()` ä¸­å®ç°å¯åŠ¨é€»è¾‘ï¼Œè€Œä¸æ˜¯è°ƒç”¨ `start_room()` å‡½æ•°ï¼š

```python
@app.route('/api/start_all', methods=['POST'])
def start_all():
    """å¯åŠ¨æ‰€æœ‰ç›´æ’­é—´"""
    started = []
    errors = []

    for room_id in list(rooms.keys()):
        try:
            if not rooms[room_id]['is_running']:
                # ç›´æ¥å®ç°å¯åŠ¨é€»è¾‘
                room_data = rooms[room_id]

                # åˆ›å»ºå¼¹å¹•æ¥æ”¶å™¨
                receiver = MultiRoomDanmakuReceiver(room_id, room_data['info'])
                room_data['receiver'] = receiver

                # åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œ
                def run_receiver(rid=room_id):
                    rooms[rid]['is_running'] = True
                    try:
                        receiver.connect()
                    except Exception as e:
                        print(f"ç›´æ’­é—´ {rid} å¼¹å¹•æ¥æ”¶é”™è¯¯: {e}")
                    finally:
                        rooms[rid]['is_running'] = False

                thread = threading.Thread(target=run_receiver, daemon=True)
                thread.start()
                room_data['thread'] = thread

                started.append(room_id)
        except Exception as e:
            errors.append({'room_id': room_id, 'error': str(e)})

    return jsonify({
        'success': True,
        'started': started,
        'errors': errors
    })
```

---

## âœ… ä¿®å¤å†…å®¹æ€»ç»“

### ä¿®å¤ 1ï¼šæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
- âœ… å¢åŠ "è®¾ç½®è¿‡æ»¤"æŒ‰é’®
- âœ… ç‹¬ç«‹çš„ `setFilter()` å‡½æ•°
- âœ… è¿‡æ»¤å™¨å¯¹æ‰€æœ‰ç›´æ’­é—´å…¨å±€ç”Ÿæ•ˆ
- âœ… æç¤ºä¿¡æ¯æ˜ç¡®è¯´æ˜"å°†å¯¹æ‰€æœ‰ç›´æ’­é—´ç”Ÿæ•ˆ"

### ä¿®å¤ 2ï¼šåœæ­¢å…¨éƒ¨åŠŸèƒ½
- âœ… ä¿®å¤ `start_all()` å‡½æ•°çš„å®ç°
- âœ… ç›´æ¥å®ç°å¯åŠ¨é€»è¾‘ï¼Œä¸è°ƒç”¨å…¶ä»–å‡½æ•°
- âœ… æ­£ç¡®å¤„ç†é”™è¯¯å’Œè¿”å›ç»“æœ

---

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### è®¾ç½®å…¨å±€è¿‡æ»¤å™¨

```
1. åœ¨"æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤"è¾“å…¥æ¡†è¾“å…¥ï¼š
   ç‹è€…è£è€€ã€[^ã€‘]+ã€‘.*?ä»Šå¤©(9[0-9]{2}|[1-9]\d{3,})å—

2. ç‚¹å‡»"è®¾ç½®è¿‡æ»¤"æŒ‰é’®

3. æç¤ºï¼šè¿‡æ»¤å™¨å·²è®¾ç½®ï¼Œå°†å¯¹æ‰€æœ‰ç›´æ’­é—´ç”Ÿæ•ˆ

4. æ·»åŠ å¤šä¸ªç›´æ’­é—´

5. å¯åŠ¨å…¨éƒ¨

6. æ‰€æœ‰ç›´æ’­é—´éƒ½ä¼šåº”ç”¨è¿™ä¸ªè¿‡æ»¤è§„åˆ™
```

### æ‰¹é‡æ“ä½œ

```
1. æ·»åŠ å¤šä¸ªç›´æ’­é—´
   - ç›´æ’­é—´1: 4253196531
   - ç›´æ’­é—´2: 7890123456
   - ç›´æ’­é—´3: 1234567890

2. è®¾ç½®è¿‡æ»¤å™¨ï¼ˆå¯é€‰ï¼‰
   - ç‚¹å‡»"è®¾ç½®è¿‡æ»¤"

3. å¯åŠ¨å…¨éƒ¨
   - ç‚¹å‡»"å¯åŠ¨å…¨éƒ¨"
   - æ‰€æœ‰ç›´æ’­é—´åŒæ—¶å¯åŠ¨

4. åœæ­¢å…¨éƒ¨
   - ç‚¹å‡»"åœæ­¢å…¨éƒ¨"
   - æ‰€æœ‰ç›´æ’­é—´åŒæ—¶åœæ­¢
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. `web_server_multi.py` - ä¿®å¤ `start_all()` å‡½æ•°
2. `templates/index_multi.html` - å¢åŠ "è®¾ç½®è¿‡æ»¤"æŒ‰é’®å’Œç‹¬ç«‹çš„è¿‡æ»¤å™¨è®¾ç½®åŠŸèƒ½

---

## ğŸš€ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨
python3 web_server_multi.py

# 2. æ‰“å¼€æµè§ˆå™¨
# è®¿é—® http://localhost:8080

# 3. æ·»åŠ å¤šä¸ªç›´æ’­é—´
# è¾“å…¥ web_ridï¼Œç‚¹å‡»"æ·»åŠ ç›´æ’­é—´"

# 4. è®¾ç½®å…¨å±€è¿‡æ»¤å™¨
# è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œç‚¹å‡»"è®¾ç½®è¿‡æ»¤"

# 5. å¯åŠ¨å…¨éƒ¨
# ç‚¹å‡»"å¯åŠ¨å…¨éƒ¨"æŒ‰é’®

# 6. åœæ­¢å…¨éƒ¨
# ç‚¹å‡»"åœæ­¢å…¨éƒ¨"æŒ‰é’®
# âœ… ç°åœ¨ä¸ä¼šæŠ¥é”™äº†ï¼
```

---

## âœ… é—®é¢˜å·²å…¨éƒ¨è§£å†³

1. âœ… æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ç°åœ¨å¯¹æ‰€æœ‰ç›´æ’­é—´å…¨å±€ç”Ÿæ•ˆ
2. âœ… åœæ­¢å…¨éƒ¨åŠŸèƒ½ä¸å†æŠ¥é”™

**å¯ä»¥æ­£å¸¸ä½¿ç”¨å¤šç›´æ’­é—´å¹¶å‘åŠŸèƒ½äº†ï¼** ğŸ‰
